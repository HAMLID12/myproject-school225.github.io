<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор макета сайта</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #1a1a2e;
            background-image: radial-gradient(circle at 25% 50%, #4a4a8a 0%, #1a1a2e 100%);
            overflow: hidden;
            color: #ecf0f1;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            position: relative;
        }

        /* Левая панель инструментов */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 25px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            color: #ecf0f1;
            background: linear-gradient(45deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            position: relative;
            padding-bottom: 10px;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            border-radius: 2px;
        }

        .tool-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .tool-button i {
            margin-right: 12px;
            font-size: 20px;
        }

        .tool-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }

        .tool-button:active {
            transform: translateY(1px);
        }

        /* Панель свойств объекта (справа) */
        .properties-panel {
            width: 280px;
            background-color: #2c3e50;
            padding: 25px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
        }

        .property-group {
            margin-bottom: 25px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .property-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
            color: #ecf0f1;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .property-control {
            margin-bottom: 20px;
        }

        .property-control:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #bdc3c7;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 14px;
            color: #ecf0f1;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            background-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        .color-picker {
            width: 100%;
            height: 45px;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
        }

        /* Основной холст */
        .canvas-container {
            flex-grow: 1;
            position: relative;
            background-color: rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .canvas {
            background-color: white;
            position: relative;
            width: 1200px;
            height: 800px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            transform-origin: center;
            overflow: visible;
            transition: transform 0.2s;
        }

        /* Диалоговое окно выбора фигур */
        .shapes-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2c3e50;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            padding: 30px;
            width: 550px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .dialog-title {
            font-size: 22px;
            font-weight: 600;
            color: #ecf0f1;
            background: linear-gradient(45deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .close-dialog {
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
        }

        .close-dialog:hover {
            color: #e74c3c;
        }

        .shapes-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .shape-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shape-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .shape-preview {
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }

        .shape-name {
            font-size: 15px;
            text-align: center;
            color: #ecf0f1;
        }

        /* Стили для объектов на холсте */
        .canvas-element {
            position: absolute;
            cursor: move;
            user-select: none;
        }

        .canvas-element.selected {
            outline: 3px solid #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .resize-handle.top-left {
            top: -6px;
            left: -6px;
            cursor: nwse-resize;
        }

        .resize-handle.top-right {
            top: -6px;
            right: -6px;
            cursor: nesw-resize;
        }

        .resize-handle.bottom-left {
            bottom: -6px;
            left: -6px;
            cursor: nesw-resize;
        }

        .resize-handle.bottom-right {
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
        }

        .canvas-text {
            min-width: 60px;
            min-height: 30px;
            padding: 8px;
            border: 1px dashed transparent;
            outline: none;
            color: #333;
        }

        .canvas-text:hover {
            border-color: #ddd;
        }

        .canvas-shape {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .canvas-image {
            display: block;
        }

        /* Контролы масштабирования */
        .zoom-controls {
            position: absolute;
            right: 25px;
            bottom: 25px;
            display: flex;
            gap: 12px;
            z-index: 50;
        }

        .zoom-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .zoom-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .zoom-level {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0 18px;
            border-radius: 25px;
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 90px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Стили для блокировки заднего фона при открытии диалога */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
            display: none;
            backdrop-filter: blur(4px);
        }

        /* Скрытый элемент для загрузки файлов */
        #file-input {
            display: none;
        }

        /* Стили для кнопки удаления */
        .delete-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            margin-top: 15px;
            transition: all 0.3s;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .delete-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Заголовок панели свойств */
        .properties-header {
            margin-bottom: 25px;
            font-size: 20px;
            font-weight: 600;
            color: #ecf0f1;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(45deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* Сообщение при отсутствии выделенного элемента */
        .no-selection-message {
            color: #bdc3c7;
            font-style: italic;
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        /* Дополнительные стили для кнопок в панели свойств */
        .property-btn-group {
            display: flex;
            gap: 12px;
        }
        
        .property-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ecf0f1;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .property-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Левая панель инструментов -->
        <div class="sidebar">
            <div class="logo">Конструктор макета</div>
            <button class="tool-button" id="create-text">
                <i>✏️</i> Создать текст
            </button>
            <button class="tool-button" id="create-shape">
                <i>🔷</i> Добавить фигуру
            </button>
            <button class="tool-button" id="import-image">
                <i>🖼️</i> Импортировать изображение
            </button>
            <input type="file" id="file-input" accept="image/*">
        </div>

        <!-- Основной холст -->
        <div class="canvas-container" id="canvas-container">
            <div class="canvas" id="canvas"></div>
            
            <!-- Контролы масштабирования -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-out">-</button>
                <div class="zoom-level" id="zoom-level">100%</div>
                <button class="zoom-btn" id="zoom-in">+</button>
            </div>
        </div>

        <!-- Панель свойств объекта (справа) -->
        <div class="properties-panel" id="properties-panel">
            <div class="properties-header">Свойства элемента</div>
            <div class="no-selection-message" id="no-selection-message">
                Выберите элемент на холсте, чтобы настроить его свойства
            </div>
            <div id="properties-content"></div>
        </div>
    </div>

    <!-- Диалоговое окно выбора фигур -->
    <div class="overlay" id="overlay"></div>
    <div class="shapes-dialog" id="shapes-dialog">
        <div class="dialog-header">
            <div class="dialog-title">Выберите фигуру</div>
            <button class="close-dialog" id="close-shapes-dialog">&times;</button>
        </div>
        <div class="shapes-list">
            <div class="shape-item" data-shape="rectangle">
                <div class="shape-preview">
                    <div style="width: 60px; height: 40px; background: linear-gradient(45deg, #3498db, #2980b9); border-radius: 5px;"></div>
                </div>
                <div class="shape-name">Прямоугольник</div>
            </div>
            <div class="shape-item" data-shape="circle">
                <div class="shape-preview">
                    <div style="width: 50px; height: 50px; background: linear-gradient(45deg, #2ecc71, #27ae60); border-radius: 50%;"></div>
                </div>
                <div class="shape-name">Круг</div>
            </div>
            <div class="shape-item" data-shape="triangle">
                <div class="shape-preview">
                    <svg width="60" height="60" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <polygon points="50,0 0,100 100,100" fill="url(#triangleGradient)" />
                        <defs>
                            <linearGradient id="triangleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#e74c3c" />
                                <stop offset="100%" stop-color="#c0392b" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="shape-name">Треугольник</div>
            </div>
            <div class="shape-item" data-shape="ellipse">
                <div class="shape-preview">
                    <div style="width: 60px; height: 40px; background: linear-gradient(45deg, #f39c12, #e67e22); border-radius: 50%;"></div>
                </div>
                <div class="shape-name">Эллипс</div>
            </div>
            <div class="shape-item" data-shape="star">
                <div class="shape-preview">
                    <svg width="50" height="50" viewBox="0 0 24 24">
                        <path d="M12 0l3.09 6.26L22 7.27l-5 4.87 1.18 6.88L12 16l-6.18 3.02L7 12.14 2 7.27l6.91-1.01L12 0z" fill="url(#starGradient)"/>
                        <defs>
                            <linearGradient id="starGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#9b59b6" />
                                <stop offset="100%" stop-color="#8e44ad" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="shape-name">Звезда</div>
            </div>
            <div class="shape-item" data-shape="hexagon">
                <div class="shape-preview">
                    <svg width="50" height="50" viewBox="0 0 24 24">
                        <path d="M21,12l-4.5,7.8L7.5,19.8L3,12l4.5-7.8L16.5,4.2L21,12z" fill="url(#hexagonGradient)"/>
                        <defs>
                            <linearGradient id="hexagonGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#1abc9c" />
                                <stop offset="100%" stop-color="#16a085" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="shape-name">Шестиугольник</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Основные элементы интерфейса
            const canvas = document.getElementById('canvas');
            const canvasContainer = document.getElementById('canvas-container');
            const propertiesPanel = document.getElementById('properties-panel');
            const propertiesContent = document.getElementById('properties-content');
            const noSelectionMessage = document.getElementById('no-selection-message');
            const createTextBtn = document.getElementById('create-text');
            const createShapeBtn = document.getElementById('create-shape');
            const importImageBtn = document.getElementById('import-image');
            const fileInput = document.getElementById('file-input');
            const shapesDialog = document.getElementById('shapes-dialog');
            const overlay = document.getElementById('overlay');
            const closeShapesDialogBtn = document.getElementById('close-shapes-dialog');
            const shapeItems = document.querySelectorAll('.shape-item');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomLevelDisplay = document.getElementById('zoom-level');

            // Состояние приложения
            let selectedElement = null;
            let isDragging = false;
            let isResizing = false;
            let currentResizeHandle = '';
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;
            let elements = [];
            let nextId = 1;
            let zoomLevel = 1; // 100%
            
            // Инициализация холста
            function initCanvas() {
                canvas.addEventListener('click', handleCanvasClick);
                canvas.addEventListener('mousedown', handleElementMouseDown);
            }
            
            // Обработка клика по холсту (снятие выделения)
            function handleCanvasClick(e) {
                if (e.target === canvas) {
                    deselectElement();
                }
            }
            
            // Обработка кнопок масштабирования
            zoomInBtn.addEventListener('click', () => {
                zoomLevel = Math.min(zoomLevel + 0.1, 3); // Максимум 300%
                updateZoom();
            });
            
            zoomOutBtn.addEventListener('click', () => {
                zoomLevel = Math.max(zoomLevel - 0.1, 0.3); // Минимум 30%
                updateZoom();
            });
            
            function updateZoom() {
                canvas.style.transform = `scale(${zoomLevel})`;
                zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
            }
            
            // Обработчики событий для кнопок создания элементов
            createTextBtn.addEventListener('click', createTextElement);
            createShapeBtn.addEventListener('click', showShapesDialog);
            importImageBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', importImage);
            closeShapesDialogBtn.addEventListener('click', closeShapesDialog);
            
            // Перебираем элементы фигур в диалоговом окне и назначаем обработчики
            shapeItems.forEach(item => {
                item.addEventListener('click', function() {
                    const shapeType = this.getAttribute('data-shape');
                    createShapeElement(shapeType);
                    closeShapesDialog();
                });
            });
            
            // ----------------------------------------
            // Создание элементов
            // ----------------------------------------
            
            // Создание текстового элемента
            function createTextElement() {
                const id = `element-${nextId++}`;
                const textElement = document.createElement('div');
                textElement.id = id;
                textElement.className = 'canvas-element canvas-text';
                textElement.contentEditable = true;
                textElement.style.left = '100px';
                textElement.style.top = '100px';
                textElement.style.color = '#000000';
                textElement.style.fontSize = '18px';
                textElement.style.fontFamily = 'Montserrat';
                textElement.style.width = 'auto';
                textElement.style.minWidth = '120px';
                textElement.style.height = 'auto';
                textElement.style.minHeight = '40px';
                textElement.style.padding = '10px';
                textElement.style.borderRadius = '5px';
                textElement.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                textElement.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                textElement.innerText = 'Двойной клик для редактирования';
                
                canvas.appendChild(textElement);
                
                const elementData = {
                    id: id,
                    type: 'text',
                    element: textElement
                };
                
                elements.push(elementData);
                selectElement(textElement);
                
                return textElement;
            }
            
            // Создание элемента-фигуры
            function createShapeElement(shapeType) {
                const id = `element-${nextId++}`;
                const shapeElement = document.createElement('div');
                shapeElement.id = id;
                shapeElement.className = 'canvas-element canvas-shape';
                shapeElement.style.left = '150px';
                shapeElement.style.top = '150px';
                shapeElement.style.width = '120px';
                shapeElement.style.height = '120px';
                shapeElement.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                
                let backgroundColor = getRandomGradient();
                
                switch(shapeType) {
                    case 'rectangle':
                        shapeElement.style.background = backgroundColor;
                        shapeElement.style.borderRadius = '8px';
                        break;
                    case 'circle':
                        shapeElement.style.background = backgroundColor;
                        shapeElement.style.borderRadius = '50%';
                        break;
                    case 'triangle':
                        shapeElement.innerHTML = `
                            <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <polygon points="50,0 0,100 100,100" fill="${backgroundColor}" />
                            </svg>
                        `;
                        break;
                    case 'ellipse':
                        shapeElement.style.background = backgroundColor;
                        shapeElement.style.borderRadius = '50%';
                        shapeElement.style.height = '80px';
                        break;
                    case 'star':
                        shapeElement.innerHTML = `
                            <svg width="100%" height="100%" viewBox="0 0 50 50" preserveAspectRatio="none">
                                <polygon points="25,5 10,40 40,20 10,20 40,40" fill="${backgroundColor}" />
                            </svg>
                        `;
                        break;
                    case 'hexagon':
                        shapeElement.innerHTML = `
                            <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <polygon points="25,0 75,0 100,50 75,100 25,100 0,50" fill="${backgroundColor}" />
                            </svg>
                        `;
                        break;
                    default:
                        shapeElement.style.background = backgroundColor;
                }
                
                canvas.appendChild(shapeElement);
                
                const elementData = {
                    id: id,
                    type: 'shape',
                    shape: shapeType,
                    element: shapeElement,
                    color: backgroundColor
                };
                
                elements.push(elementData);
                selectElement(shapeElement);
                
                return shapeElement;
            }
            
            // Импорт изображения
            function importImage(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const id = `element-${nextId++}`;
                        const imageElement = document.createElement('img');
                        imageElement.id = id;
                        imageElement.className = 'canvas-element canvas-image';
                        imageElement.src = event.target.result;
                        imageElement.style.left = '150px';
                        imageElement.style.top = '150px';
                        imageElement.style.width = '200px';
                        imageElement.style.height = 'auto';
                        imageElement.style.borderRadius = '8px';
                        imageElement.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                        
                        canvas.appendChild(imageElement);
                        
                        const elementData = {
                            id: id,
                            type: 'image',
                            element: imageElement
                        };
                        
                        elements.push(elementData);
                        selectElement(imageElement);
                        
                        // Сбрасываем input, чтобы можно было загрузить тот же файл повторно
                        fileInput.value = '';
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
            
            // ----------------------------------------
            // Обработка выделения и перемещения элементов
            // ----------------------------------------
            
            // Обработка нажатия на элемент
            function handleElementMouseDown(e) {
                if (e.target.classList.contains('resize-handle')) {
                    // Начинаем изменение размера
                    startResizing(e);
                    return;
                }
                
                const element = findElementFromEvent(e);
                if (!element) return;
                
                // Если нажали на элемент - готовимся к перетаскиванию
                if (element !== canvas) {
                    if (element !== selectedElement) {
                        selectElement(element);
                    }
                    
                    startDragging(e);
                }
            }
            
            // Начало перетаскивания элемента
            function startDragging(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const style = window.getComputedStyle(selectedElement);
                startLeft = parseFloat(style.left);
                startTop = parseFloat(style.top);
                
                document.addEventListener('mousemove', handleDragging);
                document.addEventListener('mouseup', stopDragging);
            }
            
            // Процесс перетаскивания
            function handleDragging(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                selectedElement.style.left = `${startLeft + dx}px`;
                selectedElement.style.top = `${startTop + dy}px`;
            }
            
            // Окончание перетаскивания
            function stopDragging() {
                isDragging = false;
                document.removeEventListener('mousemove', handleDragging);
                document.removeEventListener('mouseup', stopDragging);
            }
            
            // Начало изменения размера
            function startResizing(e) {
                isResizing = true;
                currentResizeHandle = e.target.className.split(' ')[1]; // получаем направление (top-left, bottom-right и т.д.)
                startX = e.clientX;
                startY = e.clientY;
                
                const style = window.getComputedStyle(selectedElement);
                startLeft = parseFloat(style.left);
                startTop = parseFloat(style.top);
                startWidth = selectedElement.offsetWidth;
                startHeight = selectedElement.offsetHeight;
                
                document.addEventListener('mousemove', handleResizing);
                document.addEventListener('mouseup', stopResizing);
            }
            
            // Процесс изменения размера
            function handleResizing(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                if (currentResizeHandle.includes('right')) {
                    newWidth = startWidth + dx;
                } 
                if (currentResizeHandle.includes('bottom')) {
                    newHeight = startHeight + dy;
                }
                if (currentResizeHandle.includes('left')) {
                    newWidth = startWidth - dx;
                    newLeft = startLeft + dx;
                }
                if (currentResizeHandle.includes('top')) {
                    newHeight = startHeight - dy;
                    newTop = startTop + dy;
                }
                
                // Минимальные размеры
                const minSize = 30;
                if (newWidth >= minSize) {
                    selectedElement.style.width = `${newWidth}px`;
                    selectedElement.style.left = `${newLeft}px`;
                }
                if (newHeight >= minSize) {
                    selectedElement.style.height = `${newHeight}px`;
                    selectedElement.style.top = `${newTop}px`;
                }
                
                // Обновляем панель свойств с новыми размерами
                updatePropertiesPanel();
            }
            
            // Окончание изменения размера
            function stopResizing() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResizing);
                document.removeEventListener('mouseup', stopResizing);
            }
            
            // Поиск элемента из события
            function findElementFromEvent(e) {
                let target = e.target;
                
                // Проверяем, является ли цель или её родители элементом canvas-element
                while (target && !target.classList.contains('canvas-element')) {
                    if (target === canvas) return target;
                    target = target.parentElement;
                }
                
                return target;
            }
            
            // ----------------------------------------
            // Работа с выделением элемента
            // ----------------------------------------
            
            // Выделение элемента
            function selectElement(element) {
                if (selectedElement) {
                    deselectElement();
                }
                
                selectedElement = element;
                element.classList.add('selected');
                
                // Добавляем маркеры-хендлеры для изменения размера
                addResizeHandles(element);
                
                // Обновляем панель свойств
                updatePropertiesPanel();
                noSelectionMessage.style.display = 'none';
            }
            
            // Снятие выделения
            function deselectElement() {
                if (selectedElement) {
                    selectedElement.classList.remove('selected');
                    removeResizeHandles();
                    selectedElement = null;
                    noSelectionMessage.style.display = 'block';
                    propertiesContent.innerHTML = '';
                }
            }
            
            // Добавление маркеров-хендлеров для изменения размера
            function addResizeHandles(element) {
                const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
                
                // Сначала удаляем существующие хендлеры, если они есть
                removeResizeHandles();
                
                // Затем создаем новые
                handles.forEach(position => {
                    const handle = document.createElement('div');
                    handle.className = `resize-handle ${position}`;
                    element.appendChild(handle);
                });
            }
            
            // Удаление маркеров-хендлеров
            function removeResizeHandles() {
                const handles = document.querySelectorAll('.resize-handle');
                handles.forEach(handle => handle.remove());
            }
            
            // ----------------------------------------
            // Обновление панели свойств
            // ----------------------------------------
            
            // Обновление панели свойств в соответствии с выделенным элементом
            function updatePropertiesPanel() {
                if (!selectedElement) return;
                
                propertiesContent.innerHTML = '';
                
                // Определяем тип элемента
                const elementData = elements.find(e => e.element === selectedElement);
                if (!elementData) return;
                
                // Общие свойства для всех элементов
                const sizeGroup = createPropertyGroup('Размеры');
                
                // Получаем текущие размеры
                const width = selectedElement.offsetWidth;
                const height = selectedElement.offsetHeight;
                
                // Добавляем контролы для размеров
                const widthControl = createPropertyControl('Ширина (px)', 'number', 'width-input', width);
                const heightControl = createPropertyControl('Высота (px)', 'number', 'height-input', height);
                
                sizeGroup.appendChild(widthControl);
                sizeGroup.appendChild(heightControl);
                propertiesContent.appendChild(sizeGroup);
                
                // Добавляем контролы в зависимости от типа элемента
                if (elementData.type === 'text') {
                    // Группа свойств шрифта
                    const fontGroup = createPropertyGroup('Шрифт');
                    
                    // Текущие стили
                    const style = window.getComputedStyle(selectedElement);
                    const fontSize = parseInt(style.fontSize);
                    const fontFamily = style.fontFamily.split(',')[0].replace(/['"]+/g, '');
                    const color = rgbToHex(style.color);
                    const bgColor = rgbToHex(style.backgroundColor);
                    
                    // Контролы для свойств текста
                    const fontSizeControl = createPropertyControl('Размер шрифта (px)', 'number', 'font-size-input', fontSize);
                    const fontFamilyControl = createFontFamilyControl(fontFamily);
                    const colorControl = createColorControl('Цвет текста', 'text-color-input', color);
                    const bgColorControl = createColorControl('Цвет фона', 'bg-color-input', bgColor);
                    
                    fontGroup.appendChild(fontSizeControl);
                    fontGroup.appendChild(fontFamilyControl);
                    fontGroup.appendChild(colorControl);
                    fontGroup.appendChild(bgColorControl);
                    propertiesContent.appendChild(fontGroup);
                    
                    // Обработчики изменений
                    document.getElementById('font-size-input').addEventListener('change', function() {
                        selectedElement.style.fontSize = this.value + 'px';
                    });
                    
                    document.getElementById('font-family-input').addEventListener('change', function() {
                        selectedElement.style.fontFamily = this.value;
                    });
                    
                    document.getElementById('text-color-input').addEventListener('change', function() {
                        selectedElement.style.color = this.value;
                    });
                    
                    document.getElementById('bg-color-input').addEventListener('change', function() {
                        selectedElement.style.backgroundColor = this.value;
                    });
                }
                
                if (elementData.type === 'shape') {
                    // Группа свойств фигуры
                    const shapeGroup = createPropertyGroup('Фигура');
                    
                    // Получаем цвет фигуры
                    let color = elementData.color || getRandomGradient();
                    
                    // Контрол для изменения цвета фигуры
                    const colorControl = createColorControl('Цвет фигуры', 'shape-color-input', color);
                    
                    shapeGroup.appendChild(colorControl);
                    propertiesContent.appendChild(shapeGroup);
                    
                    // Обработчик изменения цвета
                    document.getElementById('shape-color-input').addEventListener('change', function() {
                        const newColor = this.value;
                        elementData.color = newColor;
                        
                        // Обновляем цвет в зависимости от типа фигуры
                        if (elementData.shape === 'rectangle' || elementData.shape === 'circle' || elementData.shape === 'ellipse') {
                            selectedElement.style.background = newColor;
                        } else {
                            // Для SVG-фигур (треугольник, звезда, шестиугольник)
                            const svgPolygon = selectedElement.querySelector('polygon');
                            if (svgPolygon) {
                                svgPolygon.setAttribute('fill', newColor);
                            }
                        }
                    });
                }
                
                if (elementData.type === 'image') {
                    // Группа свойств изображения
                    const imageGroup = createPropertyGroup('Изображение');
                    
                    // Контрол для сохранения пропорций
                    const aspectRatioControl = document.createElement('div');
                    aspectRatioControl.className = 'property-control';
                    
                    const aspectRatioLabel = document.createElement('label');
                    aspectRatioLabel.innerText = 'Сохранять пропорции:';
                    
                    const aspectRatioToggle = document.createElement('input');
                    aspectRatioToggle.type = 'checkbox';
                    aspectRatioToggle.id = 'aspect-ratio-toggle';
                    aspectRatioToggle.checked = selectedElement.style.height === 'auto';
                    
                    aspectRatioLabel.appendChild(aspectRatioToggle);
                    aspectRatioControl.appendChild(aspectRatioLabel);
                    
                    imageGroup.appendChild(aspectRatioControl);
                    propertiesContent.appendChild(imageGroup);
                    
                    // Обработчик изменения сохранения пропорций
                    aspectRatioToggle.addEventListener('change', function() {
                        if (this.checked) {
                            // Сохраняем соотношение сторон (авто-высота)
                            selectedElement.style.height = 'auto';
                        } else {
                            // Фиксируем текущую высоту
                            selectedElement.style.height = selectedElement.offsetHeight + 'px';
                        }
                    });
                }
                
                // Обработчики изменения размеров для всех элементов
                document.getElementById('width-input').addEventListener('change', function() {
                    selectedElement.style.width = this.value + 'px';
                });
                
                document.getElementById('height-input').addEventListener('change', function() {
                    selectedElement.style.height = this.value + 'px';
                });
                
                // Кнопка удаления
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.innerText = 'Удалить элемент';
                deleteButton.addEventListener('click', deleteSelectedElement);
                
                propertiesContent.appendChild(deleteButton);
            }
            
            // Удаление выбранного элемента
            function deleteSelectedElement() {
                if (selectedElement) {
                    // Находим индекс элемента в массиве
                    const elementIndex = elements.findIndex(e => e.element === selectedElement);
                    
                    if (elementIndex !== -1) {
                        // Удаляем из DOM
                        selectedElement.remove();
                        
                        // Удаляем из массива
                        elements.splice(elementIndex, 1);
                        
                        // Сбрасываем выделение
                        deselectElement();
                    }
                }
            }
            
            // Создание группы свойств
            function createPropertyGroup(title) {
                const group = document.createElement('div');
                group.className = 'property-group';
                
                const titleElement = document.createElement('div');
                titleElement.className = 'property-title';
                titleElement.innerText = title;
                
                group.appendChild(titleElement);
                return group;
            }
            
            // Создание контрола свойства
            function createPropertyControl(labelText, inputType, inputId, value) {
                const control = document.createElement('div');
                control.className = 'property-control';
                
                const label = document.createElement('label');
                label.innerText = labelText;
                
                const input = document.createElement('input');
                input.type = inputType;
                input.id = inputId;
                input.value = value;
                if (inputType === 'number') {
                    input.min = 10;
                }
                
                control.appendChild(label);
                control.appendChild(input);
                
                return control;
            }
            
            // Создание контрола выбора цвета
            function createColorControl(labelText, inputId, value) {
                const control = document.createElement('div');
                control.className = 'property-control';
                
                const label = document.createElement('label');
                label.innerText = labelText;
                
                const input = document.createElement('input');
                input.type = 'color';
                input.className = 'color-picker';
                input.id = inputId;
                input.value = value;
                
                control.appendChild(label);
                control.appendChild(input);
                
                return control;
            }
            
            // Создание контрола выбора семейства шрифта
            function createFontFamilyControl(currentFont) {
                const control = document.createElement('div');
                control.className = 'property-control';
                
                const label = document.createElement('label');
                label.innerText = 'Шрифт:';
                
                const select = document.createElement('select');
                select.id = 'font-family-input';
                
                const fonts = [
                    'Montserrat', 'Arial', 'Verdana', 'Times New Roman', 
                    'Courier New', 'Georgia', 'Tahoma', 'Trebuchet MS',
                    'Roboto', 'Open Sans', 'Lato', 'Poppins'
                ];
                
                fonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.innerText = font;
                    if (font === currentFont) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                control.appendChild(label);
                control.appendChild(select);
                
                return control;
            }
            
            // ----------------------------------------
            // Диалоговое окно выбора фигур
            // ----------------------------------------
            
            // Показать диалог выбора фигур
            function showShapesDialog() {
                shapesDialog.style.display = 'block';
                overlay.style.display = 'block';
            }
            
            // Закрыть диалог выбора фигур
            function closeShapesDialog() {
                shapesDialog.style.display = 'none';
                overlay.style.display = 'none';
            }
            
            // ----------------------------------------
            // Вспомогательные функции
            // ----------------------------------------
            
            // Преобразование RGB в HEX
            function rgbToHex(rgb) {
                if (rgb.startsWith('#')) return rgb;
                
                // Извлекаем числа из строки RGB
                const rgbMatch = rgb.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);
                if (!rgbMatch) return '#000000';
                
                function hex(x) {
                    return ('0' + parseInt(x).toString(16)).slice(-2);
                }
                
                return '#' + hex(rgbMatch[1]) + hex(rgbMatch[2]) + hex(rgbMatch[3]);
            }
            
            // Генерация случайного градиента
            function getRandomGradient() {
                const colors = [
                    ['#3498db', '#2980b9'], // синий
                    ['#2ecc71', '#27ae60'], // зеленый
                    ['#e74c3c', '#c0392b'], // красный
                    ['#f39c12', '#e67e22'], // оранжевый
                    ['#9b59b6', '#8e44ad'], // фиолетовый
                    ['#1abc9c', '#16a085']  // бирюзовый
                ];
                
                const randomColors = colors[Math.floor(Math.random() * colors.length)];
                return `linear-gradient(45deg, ${randomColors[0]}, ${randomColors[1]})`;
            }
            
            // Инициализация приложения
            initCanvas();
        });
    </script>
</body>
</html>
